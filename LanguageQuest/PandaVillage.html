<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panda Village - Mandarin Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0fdfa; }
        .card { background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #2dd4bf; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #14b8a6; transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0,0,0,0.1); }
        .btn-primary:disabled, .btn-secondary:disabled, .btn-warning:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background-color: #f1f5f9; color: #1e293b; border: 2px solid #e2e8f0; }
        .btn-secondary:hover:not(:disabled) { background-color: #e2e8f0; transform: translateY(-2px); }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; transform: translateY(-2px); }
        .option-btn { border: 2px solid #e2e8f0; background-color: #f8fafc; color: #334155; }
        .option-btn:hover, .option-btn.selected { border-color: #2dd4bf; background-color: #ccfbf1; }
        .option-btn.correct { background-color: #a7f3d0; border-color: #34d399; }
        .option-btn.incorrect { background-color: #fecaca; border-color: #f87171; }
        #game-container { min-height: 500px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2dd4bf; }
        input:checked + .slider:before { transform: translateX(26px); }
        .btn-container { position: relative; }
        .notification-dot { position: absolute; top: -5px; right: -5px; height: 1.5rem; width: 3rem; background-color: #ef4444; color: white; border-radius: 9999px; font-size: 0.75rem; line-height: 1.5rem; font-weight: bold; border: 2px solid white; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="max-w-xl w-full mx-auto">
        <div class="card text-center">
             <header class="mb-4">
                 <div class="flex justify-between items-start">
                    <h1 id="header-title" class="text-3xl font-extrabold text-slate-800 text-left">Panda Village</h1>
                    <div id="coin-display" class="flex items-center space-x-2 bg-yellow-100 border-2 border-yellow-300 px-3 py-1 rounded-full" style="visibility: hidden;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.787l.09.044a2 2 0 002.208-.432l.09-.099a2 2 0 00.56-1.183V9.869a2 2 0 00-1.032-1.737l-.09-.055a2 2 0 00-1.838.163L6 10.333zM10 9.5a1.5 1.5 0 113 0v7a1.5 1.5 0 01-3 0v-7zM14 9.333v6.43a2 2 0 001.106 1.787l.09.044a2 2 0 002.208-.432l.09-.099a2 2 0 00.56-1.183V8.869a2 2 0 00-1.032-1.737l-.09-.055a2 2 0 00-1.838.163L14 9.333z"/></svg>
                        <span id="bamboo-coins" class="text-lg font-bold text-yellow-600">0</span>
                    </div>
                </div>
                 <div id="ui-toggle-container" class="flex items-center justify-end space-x-2 mt-2" style="display: none;">
                    <span class="font-semibold text-slate-600">EN</span>
                    <label class="switch"><input id="ui-toggle" type="checkbox" onchange="toggleUIMode()"><span class="slider"></span></label>
                    <span class="font-semibold text-slate-600">中文</span>
                </div>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-4" style="display: none;"><div id="progress-bar" class="bg-teal-400 h-2.5 rounded-full" style="width: 0%"></div></div>
            </header>
            <hr id="header-divider" class="my-4 border-slate-200">
            <main id="game-content"></main>
            <input type="file" id="file-loader" class="hidden" accept=".json" onchange="handleFileLoad(event)">
        </div>
    </div>
    <script>
        const uiTranslations={'Panda Village':'熊猫村','Ornate Temple':'华丽的寺庙','Lesson Pagoda':'课程宝塔','Village Market':'乡村市场','Scroll of Words':'词汇卷轴','Challenge Arena':'挑战舞台','Panda Guide':'熊猫指南','Sentence Quest':'句子任务','Lessons':'课程','Word Collection':'词汇集','Randomizer':'随机挑战','Back to Temple':'返回寺庙','Back to Lessons':'返回课程','Unlock':'解锁','Play':'开始','Replay':'重玩','Buy':'购买','Sold Out':'售罄','Collected':'已收集','Start Challenge':'开始挑战','Save':'保存','Load':'加载','New':'新'};
        const gameData={
            lessons:[
                {id:'introLesson',title:'Beginner: Panda Village Intro',description:'Your very first steps into learning Mandarin.',cost:0},
                {id:'lesson1',title:'Beginner: Polite Conversations',description:'Learn essential phrases for polite interactions.',cost:30},
                {id:'lesson2',title:'Beginner: Counting to Five',description:'Expand your number knowledge from one to five.',cost:30},
                {id:'lesson3',title:'Beginner: Common Foods',description:'Learn the words for rice, noodles, and more.',cost:35},
                {id:'lesson4',title:'Intermediate: Restaurant Visit',description:'Learn how to order food and drinks.',cost:50},
                {id:'lesson5',title:'Intermediate: Telling Time',description:'Ask for the time and understand the response.',cost:60},
                {id:'lesson6',title:'Intermediate: Daily Routines',description:'Talk about common daily activities.',cost:60},
                {id:'lesson7',title:'Advanced: Asking Directions',description:'Learn to find your way around.',cost:75},
            ],
            shopItems:[{id:'word_wo',type:'word',character:'我',pinyin:'Wǒ',meaning:'I, me',cost:15},{id:'word_ni',type:'word',character:'你',pinyin:'Nǐ',meaning:'You',cost:15},{id:'word_shi',type:'word',character:'是',pinyin:'Shì',meaning:'To be, is, yes',cost:25},{id:'word_bu',type:'word',character:'不',pinyin:'Bù',meaning:'No, not',cost:25},{id:'word_hao',type:'word',character:'好',pinyin:'Hǎo',meaning:'Good, well',cost:30},{id:'word_pengyou',type:'word',character:'朋友',pinyin:'Péngyǒu',meaning:'Friend',cost:35},{id:'word_ai',type:'word',character:'爱',pinyin:'Ài',meaning:'Love',cost:35},{id:'word_jintian',type:'word',character:'今天',pinyin:'Jīntiān',meaning:'Today',cost:40},{id:'word_mingtian',type:'word',character:'明天',pinyin:'Míngtiān',meaning:'Tomorrow',cost:40},{id:'feature_mandarin_menus',type:'feature',name:'Mandarin Menus',description:'Unlock a toggle to switch all game menus to Mandarin.',cost:75}],
            randomizer:{unlockCost:50},
            sentenceQuest:{unlockCost:75},
            sentences:[{id:'s1',english:'Hello',mandarin:['你','好'],requiredWords:['你','好']},{id:'s2',english:'I am not good.',mandarin:['我','不','好'],requiredWords:['我','不','好']},{id:'s3',english:'You are not me.',mandarin:['你','不','是','我'],requiredWords:['你','不','是','我']}]
        };

        // --- FULL LESSON STAGES DATA ---
        gameData.lessons.find(l=>l.id==='introLesson').stages = [{type:'story',story:'A friendly panda named Bao Bao greets you. To start your journey, you must learn how to say "Hello"!',buttonText:"Let's Learn!"},{type:'learn',vocab:[{character:'你好',pinyin:'Nǐ hǎo',meaning:'Hello'}],buttonText:'Ready!'},{type:'quiz',question:'How do you say "Hello" in Mandarin?',options:['Nǐ hǎo','Xièxiè','Zàijiàn'],correctAnswer:'Nǐ hǎo'},{type:'story',story:'Excellent! Bao Bao leads you to a tea house. Learn how to say "Thank you".',buttonText:'Continue'},{type:'learn',vocab:[{character:'谢谢',pinyin:'Xièxiè',meaning:'Thank you'},{character:'茶',pinyin:'Chá',meaning:'Tea'}],buttonText:'Got it!'},{type:'quiz',question:'What does "Xièxiè" mean?',options:['Hello','Thank you','Tea'],correctAnswer:'Thank you'},{type:'quiz',question:'Which word means "Tea"?',options:['Nǐ hǎo','Chá','Xièxiè'],correctAnswer:'Chá'},{type:'story',story:'You head to the market. Time to learn some numbers!',buttonText:'To the Market!'},{type:'learn',vocab:[{character:'一',pinyin:'Yī',meaning:'One'},{character:'二',pinyin:'Èr',meaning:'Two'},{character:'三',pinyin:'Sān',meaning:'Three'}],buttonText:"Let's count!"},{type:'quiz',question:'How do you say "Three" in Mandarin?',options:['Yī','Sān','Èr'],correctAnswer:'Sān'},{type:'story',story:"Your first day is ending. It's time to say goodbye.",buttonText:'Farewell...'},{type:'learn',vocab:[{character:'再见',pinyin:'Zàijiàn',meaning:'Goodbye'}],buttonText:'Okay!'},{type:'quiz',question:'What is the Mandarin word for "Goodbye"?',options:['Nǐ hǎo','Xièxiè','Zàijiàn'],correctAnswer:'Zàijiàn'}];
        gameData.lessons.find(l=>l.id==='lesson1').stages = [{type:'learn',vocab:[{character:'你好吗',pinyin:'Nǐ hǎo ma',meaning:'How are you?'},{character:'我很好',pinyin:'Wǒ hěn hǎo',meaning:'I am fine'}],buttonText:'Got it!'},{type:'quiz',question:'How do you ask "How are you?"',options:['Nǐ hǎo ma','Wǒ hěn hǎo','Duìbùqǐ'],correctAnswer:'Nǐ hǎo ma'},{type:'quiz',question:'What is the correct response to "Nǐ hǎo ma?"',options:['Bù kèqì','Wǒ hěn hǎo','Nǐ hǎo'],correctAnswer:'Wǒ hěn hǎo'},{type:'learn',vocab:[{character:'对不起',pinyin:'Duìbùqǐ',meaning:'Sorry'},{character:'没关系',pinyin:'Méiguānxì',meaning:"It's okay"}],buttonText:'Next!'},{type:'quiz',question:'Which phrase means "Sorry"?',options:['Méiguānxì','Xièxiè','Duìbùqǐ'],correctAnswer:'Duìbùqǐ'},{type:'quiz',question:'"Méiguānxì" is a response to someone saying...',options:['Nǐ hǎo','Duìbùqǐ','Zàijiàn'],correctAnswer:'Duìbùqǐ'},{type:'learn',vocab:[{character:'不客气',pinyin:'Bù kèqì',meaning:"You're welcome"}],buttonText:"I'm ready!"},{type:'quiz',question:"How do you say \"You're welcome\"?",options:['Bù kèqì','Méiguānxì','Wǒ hěn hǎo'],correctAnswer:'Bù kèqì'}];
        gameData.lessons.find(l=>l.id==='lesson2').stages = [{type:'story',story:"Let's build on the numbers you already know!",buttonText:"Let's go!"},{type:'learn',vocab:[{character:'四',pinyin:'Sì',meaning:'Four'},{character:'五',pinyin:'Wǔ',meaning:'Five'}],buttonText:'Easy!'},{type:'quiz',question:'How do you write "Four"?',options:['四','五','三'],correctAnswer:'四'},{type:'quiz',question:'What does "Wǔ" mean?',options:['Three','Four','Five'],correctAnswer:'Five'},{type:'quiz',question:'Which character is "Yī"?',options:['一','二','三'],correctAnswer:'一'},{type:'quiz',question:'Which number comes after "Sì"?',options:['Sān','Èr','Wǔ'],correctAnswer:'Wǔ'},{type:'quiz',question:'What is "Two" in pinyin?',options:['Èr','Sān','Yī'],correctAnswer:'Èr'}];
        gameData.lessons.find(l=>l.id==='lesson3').stages = [{type:'learn',vocab:[{character:'米饭',pinyin:'Mǐfàn',meaning:'Cooked Rice'},{character:'面条',pinyin:'Miàntiáo',meaning:'Noodles'}],buttonText:'Yummy!'},{type:'quiz',question:'What is "Miàntiáo"?',options:['Tea','Noodles','Rice'],correctAnswer:'Noodles'},{type:'quiz',question:'Which character means "Cooked Rice"?',options:['茶','米饭','面条'],correctAnswer:'米饭'},{type:'learn',vocab:[{character:'水',pinyin:'Shuǐ',meaning:'Water'},{character:'吃',pinyin:'Chī',meaning:'To eat'}],buttonText:'Next'},{type:'quiz',question:'How do you say "Water" in Mandarin?',options:['Chī','Shuǐ','Chá'],correctAnswer:'Shuǐ'},{type:'quiz',question:'The character "吃" means what?',options:['To drink','To want','To eat'],correctAnswer:'To eat'}];
        gameData.lessons.find(l=>l.id==='lesson4').stages = [{type:'learn',vocab:[{character:'服务员',pinyin:'Fúwùyuán',meaning:'Waiter/Waitress'},{character:'菜单',pinyin:'Càidān',meaning:'Menu'}],buttonText:"Let's begin!"},{type:'quiz',question:"How do you get a waiter's attention?",options:['Càidān','Fúwùyuán','Wǒ yào'],correctAnswer:'Fúwùyuán'},{type:'quiz',question:'What does "Càidān" mean?',options:['Water','Menu','Bill'],correctAnswer:'Menu'},{type:'learn',vocab:[{character:'我要',pinyin:'Wǒ yào',meaning:'I want...'},{character:'这个',pinyin:'Zhège',meaning:'This one'}],buttonText:'Okay'},{type:'quiz',question:'How would you say "I want this one"?',options:['Zhège yào','Wǒ zhège','Wǒ yào zhège'],correctAnswer:'Wǒ yào zhège'},{type:'learn',vocab:[{character:'买单',pinyin:'Mǎidān',meaning:'The bill, check'}],buttonText:'Ready!'},{type:'quiz',question:'What do you say when you are ready to pay?',options:['Xièxiè','Mǎidān','Fúwùyuán'],correctAnswer:'Mǎidān'},{type:'quiz',question:'Which phrase means "I want..."?',options:['Wǒ yào','Zhège','Càidān'],correctAnswer:'Wǒ yào'}];
        gameData.lessons.find(l=>l.id==='lesson5').stages = [{type:'learn',vocab:[{character:'现在',pinyin:'Xiànzài',meaning:'Now'},{character:'几点',pinyin:'Jǐ diǎn',meaning:'What time?'}],buttonText:'Ready!'},{type:'quiz',question:'How do you ask "What time is it now?"',options:['Xiànzài jǐ diǎn','Jǐ diǎn xiànzài','Diǎn jǐ xiànzài'],correctAnswer:'Xiànzài jǐ diǎn'},{type:'learn',vocab:[{character:'点',pinyin:'Diǎn',meaning:"O'clock"},{character:'分',pinyin:'Fēn',meaning:'Minute'}],buttonText:'Next'},{type:'quiz',question:'The character for "O\'clock" is...',options:['分','现在','点'],correctAnswer:'点'},{type:'quiz',question:'"San diǎn wǔ fēn" means...',options:['5:03','3:05','3:50'],correctAnswer:'3:05'},{type:'quiz',question:'What does "Jǐ diǎn" mean?',options:['How many?','What time?','Right now'],correctAnswer:'What time?'}];
        gameData.lessons.find(l=>l.id==='lesson6').stages = [{type:'learn',vocab:[{character:'起床',pinyin:'Qǐchuáng',meaning:'To get up'},{character:'睡觉',pinyin:'Shuìjiào',meaning:'To sleep'}],buttonText:'Okay!'},{type:'quiz',question:'Which word means "To sleep"?',options:['吃饭','起床','睡觉'],correctAnswer:'睡觉'},{type:'quiz',question:'"Wǒ qī diǎn qǐchuáng" means...',options:['I sleep at 7','I get up at 7','I eat at 7'],correctAnswer:'I get up at 7'},{type:'learn',vocab:[{character:'吃饭',pinyin:'Chīfàn',meaning:'To eat a meal'},{character:'工作',pinyin:'Gōngzuò',meaning:'To work'}],buttonText:'Got it'},{type:'quiz',question:'"吃饭 (Chīfàn)" specifically means:',options:['To eat rice','To eat a meal','To be hungry'],correctAnswer:'To eat a meal'},{type:'quiz',question:'How do you say "to work"?',options:['Gōngzuò','Shuìjiào','Chīfàn'],correctAnswer:'Gōngzuò'}];
        gameData.lessons.find(l=>l.id==='lesson7').stages = [{type:'learn',vocab:[{character:'请问',pinyin:'Qǐngwèn',meaning:'Excuse me... (to ask a question)'},{character:'在哪里',pinyin:'Zài nǎlǐ',meaning:'Where is...?'}],buttonText:'Let\'s ask!'},{type:'quiz',question:'How do you ask "Where is...?"',options:['Qǐngwèn','Zài nǎlǐ','Wǒ yào'],correctAnswer:'Zài nǎlǐ'},{type:'learn',vocab:[{character:'左',pinyin:'Zuǒ',meaning:'Left'},{character:'右',pinyin:'Yòu',meaning:'Right'}],buttonText:'Okay!'},{type:'quiz',question:'Which character means "Right"?',options:['左','右','去'],correctAnswer:'右'},{type:'learn',vocab:[{character:'去',pinyin:'Qù',meaning:'To go'},{character:'怎么走',pinyin:'Zěnme zǒu',meaning:'How to get to...?'}],buttonText:'Almost there!'},{type:'quiz',question:'"To go" is...',options:['Zǒu','Qù','Zài'],correctAnswer:'Qù'},{type:'quiz',question:'"...zěnme zǒu?" means...',options:['Where is...?','How to get to...?','Is it far?'],correctAnswer:'How to get to...?'}];

        let gameState={currentScreen:'intro',activeLessonId:null,currentLessonStage:0,lessonMistakes:0,selectedAnswer:null,isChineseUI:!1,activeSentence:null,playerSentence:[],randomizerQuizStages:[]};
        let playerData={bambooCoins:0,collectedWords:[],unlockedLessonIds:['introLesson'],completedLessonIds:[],randomizerUnlocked:!1,mandarinMenusUnlocked:!1,purchasedItemIds:[],sentenceQuestUnlocked:!1,seenSentenceIds:[]};

        const contentEl=document.getElementById('game-content'),coinsEl=document.getElementById('bamboo-coins'),coinDisplayEl=document.getElementById('coin-display'),titleEl=document.getElementById('header-title'),progressBarContainer=document.getElementById('progress-bar-container'),progressBar=document.getElementById('progress-bar'),uiToggleContainer=document.getElementById('ui-toggle-container'),uiToggle=document.getElementById('ui-toggle');

        function getUIText(e){return gameState.isChineseUI&&uiTranslations[e]?uiTranslations[e]:e}
        function shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}
        function getAvailableSentences(){const e=playerData.collectedWords.map(e=>e.character);return gameData.sentences.filter(t=>t.requiredWords.every(t=>e.includes(t)))}

        function render(){coinsEl.textContent=playerData.bambooCoins;progressBarContainer.style.display='none';uiToggleContainer.style.display=playerData.mandarinMenusUnlocked?'flex':'none';uiToggle.checked=gameState.isChineseUI;switch(gameState.currentScreen){case'intro':renderIntro();break;case'hub':renderHub();break;case'lessonSelect':renderLessonSelect();break;case'shop':renderShop();break;case'collection':renderWordCollection();break;case'randomizer':renderRandomizer();break;case'pandaGuide':renderPandaGuide();break;case'sentenceQuest':renderSentenceQuest();break;case'lesson':renderLessonStage();break;case'randomizerQuiz':renderRandomizerQuiz();break;}}
        function toggleUIMode(){gameState.isChineseUI=uiToggle.checked;render()}

        function renderIntro(){titleEl.textContent=getUIText('Panda Village');coinDisplayEl.style.visibility='hidden';contentEl.innerHTML=`<h2 class="text-2xl font-bold text-teal-500 mb-2">Welcome!</h2>\n                <p class="text-slate-600 text-lg mb-8">An adventure awaits. Learn your first words in Mandarin to enter the village temple!</p>\n                <button onclick="startLesson('introLesson')" class="btn btn-primary">Begin Your Journey</button>`}
        function renderHub(){titleEl.textContent=getUIText('Ornate Temple');coinDisplayEl.style.visibility='visible';const e=getAvailableSentences().filter(e=>!playerData.seenSentenceIds.includes(e.id)).length>0;contentEl.innerHTML=`<p class="text-slate-600 text-lg mb-6">Welcome to the heart of the village. Where will your journey take you next?</p>\n                <div class="grid grid-cols-2 gap-4">\n                    <button onclick="changeScreen('lessonSelect')" class="btn btn-primary h-20 text-lg">${getUIText('Lessons')}</button>\n                    <button onclick="changeScreen('pandaGuide')" class="btn btn-primary h-20 text-lg">${getUIText('Panda Guide')}</button>\n                    <button onclick="changeScreen('shop')" class="btn btn-primary h-20 text-lg">${getUIText('Village Market')}</button>\n                    <button onclick="changeScreen('collection')" class="btn btn-primary h-20 text-lg">${getUIText('Word Collection')}</button>\n                    <div class="btn-container"><button onclick="changeScreen('randomizer')" class="btn btn-warning w-full h-20 text-lg">${getUIText('Randomizer')} ${playerData.randomizerUnlocked?"":`(${gameData.randomizer.unlockCost})`}</button></div>\n                    <div class="btn-container"><button onclick="changeScreen('sentenceQuest')" class="btn btn-warning w-full h-20 text-lg">${getUIText('Sentence Quest')} ${playerData.sentenceQuestUnlocked?"":`(${gameData.sentenceQuest.unlockCost})`}</button>${playerData.sentenceQuestUnlocked&&e?`<span class="notification-dot">${getUIText('New')}</span>`:""}</div>\n                    <button onclick="saveGame()" class="btn btn-secondary h-20 text-lg">${getUIText('Save')}</button>\n                    <button onclick="document.getElementById('file-loader').click()" class="btn btn-secondary h-20 text-lg">${getUIText('Load')}</button>\n                </div>`}
        function renderPandaGuide(){titleEl.textContent=getUIText('Panda Guide');contentEl.innerHTML=`\n                <div class="text-left space-y-6">\n                    <div>\n                        <h2 class="text-2xl font-bold text-teal-600 mb-2">What is Pinyin?</h2>\n                        <p class="text-slate-700">Pinyin is a system that uses the letters of the English alphabet to represent the sounds of Mandarin Chinese characters. For example, the character for "hello", <span class="font-bold">你好</span>, is written in Pinyin as <span class="font-bold">Nǐ hǎo</span>. It helps you learn pronunciation!</p>\n                    </div>\n                    <div>\n                        <h2 class="text-2xl font-bold text-teal-600 mb-2">The Four Tones</h2>\n                        <p class="text-slate-700 mb-4">Mandarin is a tonal language. The same sound can have different meanings depending on the "tone" or pitch you use. There are four main tones and one neutral tone.</p>\n                        <ul class="space-y-3 list-disc list-inside text-slate-700">\n                            <li><span class="font-bold">First Tone (ā):</span> A high, flat sound. Like you're holding a long note while singing.</li>\n                            <li><span class="font-bold">Second Tone (á):</span> A rising sound. Like you're asking a question, "Huh?".</li>\n                            <li><span class="font-bold">Third Tone (ǎ):</span> A falling-then-rising sound. It's the longest tone.</li>\n                            <li><span class="font-bold">Fourth Tone (à):</span> A sharp, falling sound. Like a command, "Stop!".</li>\n                        </ul>\n                    </div>\n                </div>\n                <button onclick="goToHub()" class="btn btn-secondary mt-8">${getUIText('Back to Temple')}</button>`}
        function renderLessonSelect(){titleEl.textContent=getUIText('Lesson Pagoda');let e=gameData.lessons.map(e=>{const t=playerData.unlockedLessonIds.includes(e.id),n=playerData.completedLessonIds.includes(e.id);let o;return o=t?`<button onclick="startLesson('${e.id}')" class="btn btn-primary w-28">${getUIText(n?'Replay':'Play')}</button>`:`<button ${playerData.bambooCoins>=e.cost?"":'disabled'} onclick="unlockLesson('${e.id}')" class="btn btn-primary w-28">${getUIText('Unlock')} (${e.cost})</button>`,`<div class="card flex items-center justify-between p-4 mb-3 text-left border"><div><h3 class="font-bold text-slate-800 text-lg">${e.title} ${n?"✓":""}</h3><p class="text-slate-500">${e.description}</p></div>${o}</div>`}).join("");contentEl.innerHTML=`<div id="feedback" class="mb-4 min-h-[1.5rem]"></div>${e}<button onclick="goToHub()" class="btn btn-secondary mt-4">${getUIText('Back to Temple')}</button>`}
        function renderShop(){titleEl.textContent=getUIText('Village Market');let e=gameData.shopItems.map(e=>{const t=playerData.purchasedItemIds.includes(e.id),n=playerData.bambooCoins>=e.cost,o=t?`<button disabled class="btn btn-secondary w-32">${getUIText('Sold Out')}</button>`:`<button ${n?"":'disabled'} onclick="buyItem('${e.id}')" class="btn btn-primary w-32">${getUIText('Buy')} (${e.cost})</button>`,s='word'===e.type?`<div><p class="text-3xl font-bold text-slate-800">${e.character}</p><p class="text-teal-600">${e.pinyin}</p><p class="text-slate-500">${e.meaning}</p></div>`:`<div><h3 class="font-bold text-slate-800 text-lg">${e.name}</h3><p class="text-slate-500">${e.description}</p></div>`;return`<div class="card flex items-center justify-between p-4 mb-3 text-left border">${s}${o}</div>`}).join("");contentEl.innerHTML=`<div id="feedback" class="mb-4 text-green-600 font-bold min-h-[1.5rem]"></div>${e}<button onclick="goToHub()" class="btn btn-secondary mt-4">${getUIText('Back to Temple')}</button>`}
        function renderWordCollection(){titleEl.textContent=getUIText('Scroll of Words');let e=playerData.collectedWords.length>0?playerData.collectedWords.map(e=>`<div class="card p-3 border text-center"><p class="text-4xl font-bold text-slate-800">${e.character}</p><p class="text-lg text-teal-600">${e.pinyin}</p><p class="text-slate-500">${e.meaning}</p></div>`).join(""):`<p class="text-slate-500 my-8">You haven't collected any words yet!</p>`;contentEl.innerHTML=`<div class="grid grid-cols-2 md:grid-cols-3 gap-3">${e}</div><button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Temple')}</button>`}
        function renderRandomizer(){titleEl.textContent=getUIText('Challenge Arena');let e;if(playerData.randomizerUnlocked){const t=playerData.collectedWords.length>=5;e=`<p class="text-slate-600 text-lg mb-6">Test your knowledge! A random 5-question quiz will be generated from all the words you have collected.</p><button ${t?"":'disabled'} onclick="startRandomizerQuiz()" class="btn btn-primary">${getUIText('Start Challenge')}</button>${t?"":`<p class="text-red-500 mt-2">You need to collect at least 5 words to play.</p>`}`}else{const t=playerData.bambooCoins>=gameData.randomizer.unlockCost;e=`<p class="text-slate-600 text-lg mb-4">Unlock this special mode to test your entire word collection.</p><p class="text-slate-500 mb-6">Cost: ${gameData.randomizer.unlockCost} Bamboo Coins.</p><button ${t?"":'disabled'} onclick="unlockRandomizer()" class="btn btn-primary">${getUIText('Unlock')}</button>`}contentEl.innerHTML=`${e}<button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Temple')}</button>`}
        function renderLessonContent(e){gameState.selectedAnswer=null;let t="";if("story"===e.type)t=`<p class="text-slate-600 text-lg mb-8">${e.story}</p><button onclick="nextLessonStage()" class="btn btn-primary">${e.buttonText}</button>`;else if("learn"===e.type){let n=e.vocab.map(e=>`<div class="card p-4 text-center border-2 border-gray-100 w-full mb-4"><p class="text-5xl font-bold text-slate-800 mb-2">${e.character}</p><p class="text-xl text-teal-600 font-semibold">${e.pinyin}</p><p class="text-lg text-slate-500">${e.meaning}</p></div>`).join("");t=`<div class="flex flex-col items-center mb-6">${n}</div><button onclick="nextLessonStage()" class="btn btn-primary">${e.buttonText}</button>`}else if("quiz"===e.type){let n=[...e.options];shuffleArray(n);let o=n.map(e=>`<button onclick="selectAnswer(this, '${e}')" class="btn option-btn w-full text-left p-4 text-lg mb-3">${e}</button>`).join("");t=`<h2 class="text-2xl font-bold text-slate-700 mb-4">${e.question}</h2><div id="quiz-options">${o}</div><div id="feedback" class="mt-4 min-h-[2.5rem]"></div><button id="check-btn" onclick="checkAnswer()" class="btn btn-primary w-1/2 mt-4 opacity-50" disabled>Check</button>`}contentEl.innerHTML=t}
        function buyItem(e){const t=gameData.shopItems.find(t=>t.id===e);playerData.bambooCoins>=t.cost&&(playerData.bambooCoins-=t.cost,playerData.purchasedItemIds.push(t.id),"word"===t.type?addWordToCollection(t):"feature_mandarin_menus"===t.id&&(playerData.mandarinMenusUnlocked=!0),document.getElementById('feedback').innerHTML="Purchased!",render())}
        function startLesson(e){gameState.activeLessonId=e,gameState.currentLessonStage=0,gameState.lessonMistakes=0,changeScreen('lesson')}
        function renderLessonStage(){const e=gameData.lessons.find(e=>e.id===gameState.activeLessonId),t=e.stages[gameState.currentLessonStage];titleEl.textContent=getUIText(e.title),renderLessonContent(t),updateLessonProgress(gameState.currentLessonStage,e.stages.length)}
        function checkAnswer(){const e=gameData.lessons.find(e=>e.id===gameState.activeLessonId),t=e.stages[gameState.currentLessonStage],n=gameState.selectedAnswer===t.correctAnswer;n||gameState.lessonMistakes++,n&&(playerData.bambooCoins+=5),e.stages.filter(e=>'learn'===e.type).flatMap(e=>e.vocab).forEach(addWordToCollection),handleAnswerResult(n,t.correctAnswer,()=>{setTimeout(nextLessonStage,1500)})}
        function nextLessonStage(){const e=gameData.lessons.find(e=>e.id===gameState.activeLessonId);if(gameState.currentLessonStage<e.stages.length-1)gameState.currentLessonStage++,render();else{let t=0;0===gameState.lessonMistakes&&(t=10,playerData.bambooCoins+=t),coinsEl.textContent=playerData.bambooCoins,playerData.completedLessonIds.includes(e.id)||playerData.completedLessonIds.push(e.id);if("introLesson"===e.id&&1===playerData.completedLessonIds.length)return titleEl.textContent='Welcome!',void(contentEl.innerHTML=`<h2 class="text-3xl font-bold text-teal-500 mb-4">You've arrived!</h2>\n                        ${t>0?`<p class="text-yellow-500 font-bold">Perfect score! +10 bonus coins!</p>`:""}\n                        <p class="text-slate-600 text-lg mb-6">You learned your first words. Enter the temple to continue your adventure.</p>\n                        <button onclick="goToHub()" class="btn btn-primary">Enter Temple</button>`);titleEl.textContent='Lesson Complete!',contentEl.innerHTML=`<h2 class="text-3xl font-bold text-teal-500 mb-4">Well Done!</h2>\n                    ${t>0?`<p class="text-yellow-500 font-bold text-lg mb-4">Perfect score! +10 bonus coins!</p>`:""}\n                    <p class="text-slate-600 text-lg mb-6">You've strengthened your knowledge.</p>\n                    <button onclick="changeScreen('lessonSelect')" class="btn btn-primary">${getUIText("Back to Lessons")}</button>`}}
        function handleAnswerResult(e,t,n){const o=document.getElementById('feedback');document.getElementById('check-btn').disabled=!0,document.querySelectorAll('.option-btn').forEach(e=>{e.disabled=!0,e.textContent.trim()===t&&e.classList.add('correct')}),e?o.innerHTML='<p class="text-green-600 font-bold text-lg">Correct! +5 Coins!</p>':(o.innerHTML='<p class="text-red-600 font-bold text-lg">Not quite. The correct answer is highlighted.</p>',document.querySelector('.selected').classList.add('incorrect')),coinDisplayEl.style.visibility='visible',coinsEl.textContent=playerData.bambooCoins,n&&n()}
        function selectAnswer(e,t){document.querySelectorAll('.option-btn').forEach(e=>e.classList.remove('selected')),e.classList.add('selected'),gameState.selectedAnswer=t;const n=document.getElementById('check-btn');n.disabled=!1,n.classList.remove('opacity-50')}
        function renderSentenceQuest(){titleEl.textContent=getUIText('Sentence Quest');let e;if(!playerData.sentenceQuestUnlocked){const t=playerData.bambooCoins>=gameData.sentenceQuest.unlockCost;e=`<p class="text-slate-600 text-lg mb-4">Unlock this mode to build sentences from the words you've collected.</p>\n            <p class="text-slate-500 mb-6">Cost: ${gameData.sentenceQuest.unlockCost} Bamboo Coins.</p>\n            <button ${t?"":'disabled'} onclick="unlockSentenceQuest()" class="btn btn-warning">${getUIText('Unlock')}</button>`}else if(gameState.activeSentence){const t=gameState.activeSentence.mandarin.length;let n=[...gameState.activeSentence.mandarin];const o=playerData.collectedWords.filter(e=>!n.includes(e.character)).map(e=>e.character);shuffleArray(o);for(let s=0;s<2&&s<o.length;s++)n.push(o[s]);shuffleArray(n);const c=gameState.playerSentence.map((e,t)=>`<button class="btn btn-primary text-2xl p-4">${e}</button>`).join(""),l=n.map(e=>`<button class="btn btn-secondary text-2xl p-4" onclick="selectSentenceWord('${e}', this)">${e}</button>`).join(" ");e=`<div class="space-y-4">\n                <p class="text-slate-600 text-lg">Translate this sentence:</p>\n                <h2 class="text-3xl font-bold text-slate-800">"${gameState.activeSentence.english}"</h2>\n                <div id="sentence-answer-area" class="card bg-slate-100 min-h-[6rem] flex items-center justify-center flex-wrap gap-2 p-2">${c||'<span class="text-slate-400">Select words below</span>'}</div>\n                <div id="sentence-choices" class="flex flex-wrap gap-2 justify-center">${l}</div>\n                <div id="feedback" class="min-h-[1.5rem] font-bold"></div>\n                <div class="flex gap-4 justify-center">\n                    <button class="btn btn-secondary" onclick="resetSentence()">Reset</button>\n                    <button id="check-sentence-btn" class="btn btn-primary" ${gameState.playerSentence.length!==t?"disabled":""} onclick="checkSentence()">Check</button>\n                </div>\n            </div>`}else{const t=getAvailableSentences();e=`<p class="text-slate-600 text-lg mb-6">You have unlocked ${t.length} sentence(s). Collect more words to find new ones!</p>\n            <button class="btn btn-primary" ${t.length>0?"":'disabled'} onclick="startNewSentenceQuest()">Start Quest</button>\n             ${t.length>0?"":'<p class="text-red-500 mt-2">Collect more words to start!</p>'}`}contentEl.innerHTML=`${e}<button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Temple')}</button>`}
        function unlockSentenceQuest(){playerData.bambooCoins>=gameData.sentenceQuest.unlockCost&&(playerData.bambooCoins-=gameData.sentenceQuest.unlockCost,playerData.sentenceQuestUnlocked=!0,render())}
        function startNewSentenceQuest(){const e=getAvailableSentences();if(0===e.length)return;const t=e.filter(e=>!playerData.seenSentenceIds.includes(e.id));let n=t.length>0?t[Math.floor(Math.random()*t.length)]:e[Math.floor(Math.random()*e.length)];gameState.activeSentence=n,gameState.playerSentence=[],playerData.seenSentenceIds.includes(n.id)||playerData.seenSentenceIds.push(n.id),render()}
        function selectSentenceWord(e,t){gameState.playerSentence.push(e),t.disabled=!0,renderSentenceQuest()}
        function resetSentence(){gameState.playerSentence=[],renderSentenceQuest()}
        function checkSentence(){const e=gameState.playerSentence.join(""),t=gameState.activeSentence.mandarin.join("");let n;e===t?(playerData.bambooCoins+=15,coinsEl.textContent=playerData.bambooCoins,n='<p class="text-green-500">Correct! +15 Coins!</p>',setTimeout(()=>{gameState.activeSentence=null,render()},2e3)):n='<p class="text-red-500">Not quite, try again!</p>',document.getElementById('feedback').innerHTML=n}
        function startRandomizerQuiz(){if(playerData.collectedWords.length<5)return;gameState.randomizerQuizStages=[];const e=[...playerData.collectedWords];shuffleArray(e);const t=e.slice(0,5);for(const n of t){const o=['meaning','character','pinyin'][Math.floor(3*Math.random())];let s,c,l;const a=playerData.collectedWords.filter(e=>e.character!==n.character);switch(o){case'meaning':s=`What is the meaning of <b class="text-2xl">${n.character}</b>?`,c=n.meaning,l=a.map(e=>e.meaning);break;case'character':s=`Which character means "<b>${n.meaning}</b>"?`,c=n.character,l=a.map(e=>e.character);break;case'pinyin':s=`What is the pinyin for <b class="text-2xl">${n.character}</b>?`,c=n.pinyin,l=a.map(e=>e.pinyin)}shuffleArray(l);const r=[c,...l.slice(0,2)];shuffleArray(r),gameState.randomizerQuizStages.push({question:s,options:r,correctAnswer:c})}gameState.currentLessonStage=0,gameState.lessonMistakes=0,changeScreen('randomizerQuiz')}
        function renderRandomizerQuiz(){titleEl.textContent=getUIText('Randomizer');const e=gameState.randomizerQuizStages[gameState.currentLessonStage];const t=e.options.map(t=>`<button onclick="selectAnswer(this, '${t}')" class="btn option-btn w-full text-left p-4 text-lg mb-3">${t}</button>`).join("");contentEl.innerHTML=`<h2 class="text-2xl font-bold text-slate-700 mb-4">${e.question}</h2>\n        <div id="quiz-options">${t}</div>\n        <div id="feedback" class="mt-4 min-h-[2.5rem]"></div>\n        <button id="check-btn" onclick="checkRandomizerAnswer()" class="btn btn-primary w-1/2 mt-4 opacity-50" disabled>Check</button>`;updateLessonProgress(gameState.currentLessonStage,gameState.randomizerQuizStages.length)}
        function checkRandomizerAnswer(){const e=gameState.randomizerQuizStages[gameState.currentLessonStage];const t=gameState.selectedAnswer===e.correctAnswer;t?playerData.bambooCoins+=10:gameState.lessonMistakes++;handleAnswerResult(t,e.correctAnswer,()=>{setTimeout(nextRandomizerStage,1500)})}
        function nextRandomizerStage(){if(gameState.currentLessonStage<gameState.randomizerQuizStages.length-1){gameState.currentLessonStage++;changeScreen('randomizerQuiz')}else{let e='';0===gameState.lessonMistakes&&(playerData.bambooCoins+=25,e='<p class="text-yellow-500 font-bold text-lg mb-4">Perfect score! +25 bonus coins!</p>');coinsEl.textContent=playerData.bambooCoins;titleEl.textContent='Challenge Complete!';contentEl.innerHTML=`<h2 class="text-3xl font-bold text-teal-500 mb-4">Great Job!</h2>\n                ${e}\n                <p class="text-slate-600 text-lg mb-6">You've tested your knowledge and sharpened your skills.</p>\n                <button onclick="goToHub()" class="btn btn-primary">Back to Temple</button>`;gameState.randomizerQuizStages=[]}}
        function updateLessonProgress(e,t){progressBarContainer.style.display='block';progressBar.style.width=`${e/t*100}%`}
        function goToHub(){changeScreen('hub')}
        function changeScreen(e){gameState.currentScreen=e;render()}
        function unlockLesson(e){const t=gameData.lessons.find(t=>t.id===e);playerData.bambooCoins>=t.cost&&(playerData.bambooCoins-=t.cost,playerData.unlockedLessonIds.push(e),document.getElementById('feedback').innerHTML='<p class="text-green-600 font-bold">Lesson unlocked!</p>',setTimeout(render,1e3))}
        function unlockRandomizer(){playerData.bambooCoins>=gameData.randomizer.unlockCost&&(playerData.bambooCoins-=gameData.randomizer.unlockCost,playerData.randomizerUnlocked=!0,render())}
        function addWordToCollection(e){playerData.collectedWords.some(t=>t.character===e.character)||playerData.collectedWords.push({character:e.character,pinyin:e.pinyin,meaning:e.meaning})}
        function saveGame(){try{const e=JSON.stringify(playerData),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement('a');o.href=n,o.download='panda-village-save.json',document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}catch(e){console.error("Save failed:",e),alert("Sorry, the game could not be saved. Please try again.")}}
        function handleFileLoad(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){try{const t=JSON.parse(e.target.result);t&&void 0!==t.bambooCoins&&Array.isArray(t.collectedWords)?(playerData=t,goToHub()):alert("Invalid save file.")}catch(t){console.error("Failed to load or parse save file:",t),alert("Could not load the save file. It may be corrupted.")}},n.readAsText(t)}
        render();
    </script>
</body>
</html>

