<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fox Shrine - Japanese Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #fff7f7; }
        .card { background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #ef4444; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0,0,0,0.1); }
        .btn-primary:disabled, .btn-secondary:disabled, .btn-warning:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background-color: #f1f5f9; color: #1e293b; border: 2px solid #e2e8f0; }
        .btn-secondary:hover:not(:disabled) { background-color: #e2e8f0; transform: translateY(-2px); }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; transform: translateY(-2px); }
        .option-btn { border: 2px solid #e2e8f0; background-color: #f8fafc; color: #334155; }
        .option-btn:hover, .option-btn.selected { border-color: #ef4444; background-color: #fee2e2; }
        .option-btn.correct { background-color: #a7f3d0; border-color: #34d399; }
        .option-btn.incorrect { background-color: #fecaca; border-color: #f87171; }
        #game-container { min-height: 500px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ef4444; }
        input:checked + .slider:before { transform: translateX(26px); }
        .btn-container { position: relative; }
        .notification-dot { position: absolute; top: -5px; right: -5px; height: 1.5rem; width: 3rem; background-color: #3b82f6; color: white; border-radius: 9999px; font-size: 0.75rem; line-height: 1.5rem; font-weight: bold; border: 2px solid white; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="max-w-xl w-full mx-auto">
        <div class="card text-center">
             <header class="mb-4">
                 <div class="flex justify-between items-start">
                    <h1 id="header-title" class="text-3xl font-extrabold text-slate-800 text-left">Fox Shrine</h1>
                    <div id="coin-display" class="flex items-center space-x-2 bg-emerald-100 border-2 border-emerald-300 px-3 py-1 rounded-full" style="visibility: hidden;">
                        <!-- Magatama Gem Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v4.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 9.586V5z" clip-rule="evenodd" /></svg>
                        <span id="magatama-gems" class="text-lg font-bold text-emerald-600">0</span>
                    </div>
                </div>
                 <div id="ui-toggle-container" class="flex items-center justify-end space-x-2 mt-2" style="display: none;">
                    <span class="font-semibold text-slate-600">EN</span>
                    <label class="switch"><input id="ui-toggle" type="checkbox" onchange="toggleUIMode()"><span class="slider"></span></label>
                    <span class="font-semibold text-slate-600">日本語</span>
                </div>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-4" style="display: none;"><div id="progress-bar" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div></div>
            </header>
            <hr id="header-divider" class="my-4 border-slate-200">
            <main id="game-content"></main>
            <input type="file" id="file-loader" class="hidden" accept=".json" onchange="handleFileLoad(event)">
        </div>
    </div>
<script>
    // --- DICTIONARY & GAME DATA ---
    const uiTranslations = {
        'Fox Shrine': '狐の神社', 'Main Shrine': '本殿', 'Practice Tower': '稽古の塔', 'Village Market': '村の市場',
        'Scroll of Words': '言葉の巻物', 'Challenge Arena': '挑戦の場', 'Fox Guide': '狐の案内', 'Sentence Quest': '文章の探求',
        'Lessons': '稽古', 'Word Collection': '言葉集め', 'Randomizer': 'ランダマイザー', 'Back to Shrine': '本殿へ戻る',
        'Back to Lessons': '稽古へ戻る', 'Unlock': '解放', 'Play': '開始', 'Replay': '再挑戦', 'Buy': '買う',
        'Sold Out': '売り切れ', 'Collected': '収集済み', 'Start Challenge': '挑戦開始', 'Save': '保存', 'Load': '読込', 'New': '新'
    };

    const gameData = {
        lessons: [
            // Beginner
            { id: 'introLesson', title: 'Beginner: First Shrine Visit', description: 'Your first steps into the world of Japanese.', cost: 0 },
            { id: 'lesson2', title: 'Beginner: Counting to Five', description: 'Learn the numbers from one to five.', cost: 30 },
            { id: 'lesson3', title: 'Beginner: Common Foods', description: 'Learn the words for rice, bread, and water.', cost: 35 },
            { id: 'lesson1', title: 'Beginner: Polite Phrases', description: 'Learn essential phrases for polite interactions.', cost: 30 },
            // Intermediate
            { id: 'lesson4', title: 'Intermediate: At a Restaurant', description: 'Learn how to order food and drinks.', cost: 50 },
            { id: 'lesson5', title: 'Intermediate: Basic Particles', description: 'Understand the essential particles は and を.', cost: 60 },
            { id: 'lesson6', title: 'Intermediate: Simple Adjectives', description: 'Describe things as big, small, good, or bad.', cost: 60 },
             // Advanced
            { id: 'lesson7', title: 'Advanced: Past Tense Verbs', description: 'Learn how to say you did something.', cost: 80 },
        ],
        shopItems: [
            { id: 'word_watashi', type: 'word', character: '私', romaji: 'Watashi', meaning: 'I, me', cost: 15 },
            { id: 'word_anata', type: 'word', character: 'あなた', romaji: 'Anata', meaning: 'You', cost: 15 },
            { id: 'word_desu', type: 'word', character: 'です', romaji: 'Desu', meaning: 'is, am, are', cost: 25 },
            { id: 'word_wa', type: 'word', character: 'は', romaji: 'wa (particle)', meaning: 'Topic marker', cost: 25 },
            { id: 'word_neko', type: 'word', character: '猫', romaji: 'Neko', meaning: 'Cat', cost: 30 },
            { id: 'word_inu', type: 'word', character: '犬', romaji: 'Inu', meaning: 'Dog', cost: 30 },
            { id: 'word_nomimasu', type: 'word', character: '飲みます', romaji: 'Nomimasu', meaning: 'To drink', cost: 40 },
            { id: 'word_tabemashita', type: 'word', character: '食べました', romaji: 'Tabemashita', meaning: 'Ate (past)', cost: 45 },
            { id: 'word_kino', type: 'word', character: '昨日', romaji: 'Kinō', meaning: 'Yesterday', cost: 40 },
            { id: 'feature_japanese_menus', type: 'feature', name: 'Japanese Menus', description: 'Unlock a toggle to switch all game menus to Japanese.', cost: 75 }
        ],
        randomizer: { unlockCost: 50 },
        sentenceQuest: { unlockCost: 75 },
        sentences: [
            { id: 's1', english: 'I am a cat.', japanese: ['私', 'は', '猫', 'です'], requiredWords: ['私', 'は', '猫', 'です'] },
            { id: 's2', english: 'You are a dog.', japanese: ['あなた', 'は', '犬', 'です'], requiredWords: ['あなた', 'は', '犬', 'です'] },
            { id: 's3', english: 'This is water.', japanese: ['これ', 'は', '水', 'です'], requiredWords: ['これ', 'は', '水', 'です'] },
            { id: 's4', english: 'I ate bread.', japanese: ['私', 'は', 'パン', 'を', '食べました'], requiredWords: ['私', 'は', 'パン', 'を', '食べました'] }
        ]
    };

    // --- FULL LESSON STAGES DATA ---
    gameData.lessons.find(l => l.id === 'introLesson').stages = [
        { type: 'story', story: 'A friendly fox spirit named Ren greets you. To start your journey, you must learn how to say "Hello"!', buttonText: "Let's Learn!" },
        { type: 'learn', vocab: [{ character: 'こんにちは', romaji: 'Konnichiwa', meaning: 'Hello' }], buttonText: 'Ready!' },
        { type: 'quiz', question: 'How do you say "Hello" in Japanese?', options: ['Konnichiwa', 'Sayōnara', 'Arigatō'], correctAnswer: 'Konnichiwa' },
        { type: 'story', story: 'Excellent! Ren leads you to a tea house. Learn how to say "Thank you".', buttonText: 'Continue' },
        { type: 'learn', vocab: [{ character: 'ありがとう', romaji: 'Arigatō', meaning: 'Thank you' }, { character: 'お茶', romaji: 'Ocha', meaning: 'Tea' }], buttonText: 'Got it!' },
        { type: 'quiz', question: 'What does "Arigatō" mean?', options: ['Hello', 'Thank you', 'Tea'], correctAnswer: 'Thank you' },
        { type: 'quiz', question: 'Which word means "Tea"?', options: ['Konnichiwa', 'Ocha', 'Arigatō'], correctAnswer: 'Ocha' },
        { type: 'story', story: 'You are leaving the shrine for now. Time to learn how to say goodbye.', buttonText: 'Farewell...' },
        { type: 'learn', vocab: [{ character: 'さようなら', romaji: 'Sayōnara', meaning: 'Goodbye' }], buttonText: 'Okay!' },
        { type: 'quiz', question: 'What is the Japanese word for "Goodbye"?', options: ['Konnichiwa', 'Arigatō', 'Sayōnara'], correctAnswer: 'Sayōnara' }
    ];
    gameData.lessons.find(l => l.id === 'lesson2').stages = [
        { type: 'story', story: "Let's learn some numbers!", buttonText: "Let's go!" },
        { type: 'learn', vocab: [{ character: '一', romaji: 'Ichi', meaning: 'One' }, { character: '二', romaji: 'Ni', meaning: 'Two' }, { character: '三', romaji: 'San', meaning: 'Three' }], buttonText: 'Easy!' },
        { type: 'quiz', question: 'How do you write "Two"?', options: ['一', '二', '三'], correctAnswer: '二' },
        { type: 'learn', vocab: [{ character: '四', romaji: 'Shi / Yon', meaning: 'Four' }, { character: '五', romaji: 'Go', meaning: 'Five' }], buttonText: 'Next!' },
        { type: 'quiz', question: 'What does "Go" mean?', options: ['Three', 'Four', 'Five'], correctAnswer: 'Five' },
        { type: 'quiz', question: 'Which character is "San"?', options: ['一', '三', '五'], correctAnswer: '三' }
    ];
    gameData.lessons.find(l => l.id === 'lesson3').stages = [
        { type: 'learn', vocab: [{ character: 'ご飯', romaji: 'Gohan', meaning: 'Cooked Rice' }, { character: 'パン', romaji: 'Pan', meaning: 'Bread' }], buttonText: 'Yummy!' },
        { type: 'quiz', question: 'What is "Pan"?', options: ['Tea', 'Bread', 'Rice'], correctAnswer: 'Bread' },
        { type: 'quiz', question: 'Which word means "Cooked Rice"?', options: ['お茶', 'ご飯', 'パン'], correctAnswer: 'ご飯' },
        { type: 'learn', vocab: [{ character: '水', romaji: 'Mizu', meaning: 'Water' }, { character: '食べる', romaji: 'Taberu', meaning: 'To eat' }], buttonText: 'Next' },
        { type: 'quiz', question: 'How do you say "Water" in Japanese?', options: ['Taberu', 'Mizu', 'Ocha'], correctAnswer: 'Mizu' },
        { type: 'quiz', question: 'The word "食べる" means what?', options: ['To drink', 'To want', 'To eat'], correctAnswer: 'To eat' }
    ];
    gameData.lessons.find(l => l.id === 'lesson1').stages = [
        { type: 'learn', vocab: [{ character: 'おはよう', romaji: 'Ohayō', meaning: 'Good morning' }, { character: 'こんばんは', romaji: 'Konbanwa', meaning: 'Good evening' }], buttonText: 'Got it!' },
        { type: 'quiz', question: 'How do you greet someone in the morning?', options: ['Konbanwa', 'Ohayō', 'Oyasumi'], correctAnswer: 'Ohayō' },
        { type: 'learn', vocab: [{ character: 'すみません', romaji: 'Sumimasen', meaning: 'Excuse me / Sorry' }, { character: 'はい', romaji: 'Hai', meaning: "Yes" }], buttonText: 'Next!' },
        { type: 'quiz', question: 'Which phrase means "Excuse me"?', options: ['Hai', 'Arigatō', 'Sumimasen'], correctAnswer: 'Sumimasen' },
        { type: 'quiz', question: "How do you say \"Yes\"?", options: ['はい (Hai)', 'いいえ (Iie)', 'どうぞ (Dōzo)'], correctAnswer: 'はい (Hai)' }
    ];
    gameData.lessons.find(l => l.id === 'lesson4').stages = [
        { type: 'learn', vocab: [{ character: 'これ', romaji: 'Kore', meaning: 'This' }, { character: 'ください', romaji: 'Kudasai', meaning: 'Please give me' }], buttonText: "Let's begin!" },
        { type: 'quiz', question: 'How would you say "This, please"?', options: ['Kore kudasai', 'Kudasai kore', 'Kore desu'], correctAnswer: 'Kore kudasai' },
        { type: 'learn', vocab: [{ character: 'メニュー', romaji: 'Menyū', meaning: 'Menu' }, { character: 'おいしい', romaji: 'Oishii', meaning: 'Delicious' }], buttonText: 'Okay' },
        { type: 'quiz', question: 'What does "Oishii" mean?', options: ['Water', 'Delicious', 'Check, please'], correctAnswer: 'Delicious' },
        { type: 'quiz', question: 'The word for menu is...', options: ['Menyū', 'Ocha', 'Mizu'], correctAnswer: 'Menyū' }
    ];
    gameData.lessons.find(l => l.id === 'lesson5').stages = [
        { type: 'learn', vocab: [{ character: 'は', romaji: 'wa', meaning: 'Topic particle (marks the subject)' }, { character: 'を', romaji: 'o', meaning: 'Object particle (marks the direct object)' }], buttonText: 'Ready!' },
        { type: 'quiz', question: 'In "猫は魚を食べる" (The cat eats fish), which particle marks "cat" as the topic?', options: ['は (wa)', 'を (o)'], correctAnswer: 'は (wa)' },
        { type: 'quiz', question: 'In "私はパンを食べる" (I eat bread), which particle marks "bread" as the object?', options: ['は (wa)', 'を (o)'], correctAnswer: 'を (o)' },
        { type: 'story', story: 'Particles are tricky but essential. Let\'s practice!', buttonText: 'Continue' },
        { type: 'quiz', question: 'Choose the correct particle: あなた __ 猫です (You are a cat)', options: ['は (wa)', 'を (o)'], correctAnswer: 'は (wa)' },
        { type: 'quiz', question: 'Choose the correct particle: ご飯 __ 食べる (Eat rice)', options: ['は (wa)', 'を (o)'], correctAnswer: 'を (o)' }
    ];
    gameData.lessons.find(l => l.id === 'lesson6').stages = [
        { type: 'learn', vocab: [{ character: '大きい', romaji: 'Ōkii', meaning: 'Big' }, { character: '小さい', romaji: 'Chiisai', meaning: 'Small' }], buttonText: 'Okay!' },
        { type: 'quiz', question: 'Which word means "Big"?', options: ['Ōkii', 'Chiisai', 'Ii'], correctAnswer: 'Ōkii' },
        { type: 'learn', vocab: [{ character: '良い', romaji: 'Ii / Yoi', meaning: 'Good' }, { character: '悪い', romaji: 'Warui', meaning: 'Bad' }], buttonText: 'Got it' },
        { type: 'quiz', question: '"Warui" means:', options: ['Good', 'Small', 'Bad'], correctAnswer: 'Bad' },
        { type: 'quiz', question: 'How do you say "Good"?', options: ['Ōkii', 'Ii', 'Warui'], correctAnswer: 'Ii' }
    ];
    gameData.lessons.find(l => l.id === 'lesson7').stages = [
        { type: 'learn', vocab: [{ character: '食べました', romaji: 'Tabemashita', meaning: 'Ate (past tense of 食べる)'}, { character: '飲みました', romaji: 'Nomimashita', meaning: 'Drank (past tense of 飲みます)'}], buttonText: 'Okay!' },
        { type: 'quiz', question: 'How do you say "ate"?', options: ['Tabemashita', 'Nomimashita', 'Taberu'], correctAnswer: 'Tabemashita' },
        { type: 'story', story: 'Past tense is usually formed by changing ます (masu) to ました (mashita).', buttonText: 'Interesting!'},
        { type: 'quiz', question: 'What is the past tense of 飲みます (Nomimasu)?', options: ['Nomimashita', 'Nomimasu', 'Nomimasen'], correctAnswer: 'Nomimashita' },
        { type: 'quiz', question: '"昨日、水を飲みました" (Kinō, mizu o nomimashita) means...', options: ['Yesterday, I drank water.', 'Tomorrow, I will drink water.', 'I am drinking water.'], correctAnswer: 'Yesterday, I drank water.' }
    ];

    // --- GAME STATE & PLAYER DATA ---
    let gameState = { currentScreen: 'intro', activeLessonId: null, currentLessonStage: 0, lessonMistakes: 0, selectedAnswer: null, isJapaneseUI: false, activeSentence: null, playerSentence: [], randomizerQuestions: [], currentRandomizerQuestion: 0, randomizerScore: 0 };
    let playerData = { magatamaGems: 0, collectedWords: [], unlockedLessonIds: ['introLesson'], completedLessonIds: [], randomizerUnlocked: false, japaneseMenusUnlocked: false, purchasedItemIds: [], sentenceQuestUnlocked: false, seenSentenceIds: [] };

    const contentEl = document.getElementById('game-content'), gemsEl = document.getElementById('magatama-gems'), gemDisplayEl = document.getElementById('coin-display'), titleEl = document.getElementById('header-title'), progressBarContainer = document.getElementById('progress-bar-container'), progressBar = document.getElementById('progress-bar'), uiToggleContainer = document.getElementById('ui-toggle-container'), uiToggle = document.getElementById('ui-toggle');

    // --- CORE FUNCTIONS ---
    function getUIText(key) { return gameState.isJapaneseUI && uiTranslations[key] ? uiTranslations[key] : key; }
    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } }
    function getAvailableSentences() { const collectedChars = playerData.collectedWords.map(w => w.character); return gameData.sentences.filter(s => s.requiredWords.every(char => collectedChars.includes(char))); }

    // --- RENDER FUNCTIONS ---
    function render() {
        gemsEl.textContent = playerData.magatamaGems;
        progressBarContainer.style.display = 'none';
        uiToggleContainer.style.display = playerData.japaneseMenusUnlocked ? 'flex' : 'none';
        uiToggle.checked = gameState.isJapaneseUI;
        switch (gameState.currentScreen) {
            case 'intro': renderIntro(); break;
            case 'hub': renderHub(); break;
            case 'lessonSelect': renderLessonSelect(); break;
            case 'shop': renderShop(); break;
            case 'collection': renderWordCollection(); break;
            case 'randomizer': renderRandomizer(); break;
            case 'randomizerQuiz': renderRandomizerQuiz(); break;
            case 'foxGuide': renderFoxGuide(); break;
            case 'sentenceQuest': renderSentenceQuest(); break;
            case 'lesson': renderLessonStage(); break;
        }
    }

    function toggleUIMode() { gameState.isJapaneseUI = uiToggle.checked; render(); }

    function renderIntro() { titleEl.textContent = getUIText('Fox Shrine'); gemDisplayEl.style.visibility = 'hidden'; contentEl.innerHTML = `<h2 class="text-2xl font-bold text-red-500 mb-2">ようこそ！ (Welcome!)</h2><p class="text-slate-600 text-lg mb-8">An adventure awaits. Learn your first words in Japanese to enter the shrine!</p><button onclick="startLesson('introLesson')" class="btn btn-primary">Begin Your Journey</button>`; }

    function renderHub() {
        titleEl.textContent = getUIText('Main Shrine'); gemDisplayEl.style.visibility = 'visible';
        const hasNewSentences = getAvailableSentences().filter(s => !playerData.seenSentenceIds.includes(s.id)).length > 0;
        contentEl.innerHTML = `<p class="text-slate-600 text-lg mb-6">Welcome to the heart of the shrine. Where will your journey take you next?</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="changeScreen('lessonSelect')" class="btn btn-primary h-20 text-lg">${getUIText('Lessons')}</button>
                <button onclick="changeScreen('foxGuide')" class="btn btn-primary h-20 text-lg">${getUIText('Fox Guide')}</button>
                <button onclick="changeScreen('shop')" class="btn btn-primary h-20 text-lg">${getUIText('Village Market')}</button>
                <button onclick="changeScreen('collection')" class="btn btn-primary h-20 text-lg">${getUIText('Word Collection')}</button>
                <div class="btn-container"><button onclick="changeScreen('randomizer')" class="btn btn-warning w-full h-20 text-lg">${getUIText('Randomizer')} ${playerData.randomizerUnlocked ? "" : `(${gameData.randomizer.unlockCost})`}</button></div>
                <div class="btn-container"><button onclick="changeScreen('sentenceQuest')" class="btn btn-warning w-full h-20 text-lg">${getUIText('Sentence Quest')} ${playerData.sentenceQuestUnlocked ? "" : `(${gameData.sentenceQuest.unlockCost})`}</button>${(playerData.sentenceQuestUnlocked && hasNewSentences) ? `<span class="notification-dot">${getUIText('New')}</span>` : ""}</div>
                <button onclick="saveGame()" class="btn btn-secondary h-20 text-lg">${getUIText('Save')}</button>
                <button onclick="document.getElementById('file-loader').click()" class="btn btn-secondary h-20 text-lg">${getUIText('Load')}</button>
            </div>`;
    }

    function renderFoxGuide() { titleEl.textContent = getUIText('Fox Guide'); contentEl.innerHTML = `<div class="text-left space-y-6"><div><h2 class="text-2xl font-bold text-red-600 mb-2">What are Kana and Kanji?</h2><p class="text-slate-700">Japanese uses three writing systems!<ul class="space-y-2 list-disc list-inside text-slate-700 mt-2"><li><span class="font-bold">Hiragana (ひらがな):</span> Used for native Japanese words and grammar. Eg: こんにちは (konnichiwa).</li><li><span class="font-bold">Katakana (カタカナ):</span> Used for foreign loanwords and emphasis. Eg: パン (pan, from Portuguese for bread).</li><li><span class="font-bold">Kanji (漢字):</span> Characters borrowed from Chinese, used for nouns and verb stems. Eg: 猫 (neko, cat).</li></ul></p></div><div><h2 class="text-2xl font-bold text-red-600 mb-2">Sentence Structure</h2><p class="text-slate-700 mb-2">Unlike English (Subject-Verb-Object), Japanese is typically <span class="font-bold">Subject-Object-Verb</span>.</p><p class="text-slate-700">Small words called <span class="font-bold">particles</span> mark the role of each word. For example, <span class="font-bold">は (wa)</span> marks the topic, and <span class="font-bold">を (o)</span> marks the object.</p><p class="text-slate-700 mt-2">Example: <span class="font-bold">私 は パン を 食べます。</span> (Watashi wa pan o tabemasu.)<br>Literally: "I [topic] bread [object] eat."</p></div></div><button onclick="goToHub()" class="btn btn-secondary mt-8">${getUIText('Back to Shrine')}</button>`; }

    function renderLessonSelect() { titleEl.textContent = getUIText('Practice Tower'); let lessonHTML = gameData.lessons.map(lesson => { const isUnlocked = playerData.unlockedLessonIds.includes(lesson.id), isCompleted = playerData.completedLessonIds.includes(lesson.id); let buttonHTML; if (isUnlocked) { buttonHTML = `<button onclick="startLesson('${lesson.id}')" class="btn btn-primary w-28">${getUIText(isCompleted ? 'Replay' : 'Play')}</button>`; } else { buttonHTML = `<button ${playerData.magatamaGems >= lesson.cost ? "" : 'disabled'} onclick="unlockLesson('${lesson.id}')" class="btn btn-primary w-28">${getUIText('Unlock')} (${lesson.cost})</button>`; } return `<div class="card flex items-center justify-between p-4 mb-3 text-left border"><div><h3 class="font-bold text-slate-800 text-lg">${lesson.title} ${isCompleted ? "✓" : ""}</h3><p class="text-slate-500">${lesson.description}</p></div>${buttonHTML}</div>`; }).join(''); contentEl.innerHTML = `<div id="feedback" class="mb-4 min-h-[1.5rem]"></div>${lessonHTML}<button onclick="goToHub()" class="btn btn-secondary mt-4">${getUIText('Back to Shrine')}</button>`; }

    function renderShop() { titleEl.textContent = getUIText('Village Market'); let itemsHTML = gameData.shopItems.map(item => { const isPurchased = playerData.purchasedItemIds.includes(item.id), canAfford = playerData.magatamaGems >= item.cost; const buttonHTML = isPurchased ? `<button disabled class="btn btn-secondary w-32">${getUIText('Sold Out')}</button>` : `<button ${canAfford ? "" : 'disabled'} onclick="buyItem('${item.id}')" class="btn btn-primary w-32">${getUIText('Buy')} (${item.cost})</button>`; const itemInfo = item.type === 'word' ? `<div><p class="text-3xl font-bold text-slate-800">${item.character}</p><p class="text-red-600">${item.romaji}</p><p class="text-slate-500">${item.meaning}</p></div>` : `<div><h3 class="font-bold text-slate-800 text-lg">${item.name}</h3><p class="text-slate-500">${item.description}</p></div>`; return `<div class="card flex items-center justify-between p-4 mb-3 text-left border">${itemInfo}${buttonHTML}</div>`; }).join(''); contentEl.innerHTML = `<div id="feedback" class="mb-4 text-green-600 font-bold min-h-[1.5rem]"></div>${itemsHTML}<button onclick="goToHub()" class="btn btn-secondary mt-4">${getUIText('Back to Shrine')}</button>`; }

    function renderWordCollection() { titleEl.textContent = getUIText('Scroll of Words'); let wordsHTML = playerData.collectedWords.length > 0 ? playerData.collectedWords.map(word => `<div class="card p-3 border text-center"><p class="text-4xl font-bold text-slate-800">${word.character}</p><p class="text-lg text-red-600">${word.romaji}</p><p class="text-slate-500">${word.meaning}</p></div>`).join('') : `<p class="text-slate-500 my-8">You haven't collected any words yet!</p>`; contentEl.innerHTML = `<div class="grid grid-cols-2 md:grid-cols-3 gap-3">${wordsHTML}</div><button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Shrine')}</button>`; }

    function renderRandomizer() { titleEl.textContent = getUIText('Challenge Arena'); let content; if (playerData.randomizerUnlocked) { const canPlay = playerData.collectedWords.length >= 5; content = `<p class="text-slate-600 text-lg mb-6">Test your knowledge! A random 5-question quiz will be generated from all the words you have collected.</p><button ${canPlay ? "" : 'disabled'} onclick="startRandomizer()" class="btn btn-primary">${getUIText('Start Challenge')}</button>${!canPlay ? `<p class="text-red-500 mt-2">You need to collect at least 5 words to play.</p>` : ''}`; } else { const canAfford = playerData.magatamaGems >= gameData.randomizer.unlockCost; content = `<p class="text-slate-600 text-lg mb-4">Unlock this special mode to test your entire word collection.</p><p class="text-slate-500 mb-6">Cost: ${gameData.randomizer.unlockCost} Magatama Gems.</p><button ${canAfford ? "" : 'disabled'} onclick="unlockRandomizer()" class="btn btn-primary">${getUIText('Unlock')}</button>`; } contentEl.innerHTML = `${content}<button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Shrine')}</button>`; }

    function renderLessonContent(stage) { gameState.selectedAnswer = null; let contentHTML = ""; if (stage.type === 'story') { contentHTML = `<p class="text-slate-600 text-lg mb-8">${stage.story}</p><button onclick="nextLessonStage()" class="btn btn-primary">${stage.buttonText}</button>`; } else if (stage.type === 'learn') { let vocabHTML = stage.vocab.map(v => `<div class="card p-4 text-center border-2 border-gray-100 w-full mb-4"><p class="text-5xl font-bold text-slate-800 mb-2">${v.character}</p><p class="text-xl text-red-600 font-semibold">${v.romaji}</p><p class="text-lg text-slate-500">${v.meaning}</p></div>`).join(''); contentHTML = `<div class="flex flex-col items-center mb-6">${vocabHTML}</div><button onclick="nextLessonStage()" class="btn btn-primary">${stage.buttonText}</button>`; } else if (stage.type === 'quiz') { let options = [...stage.options]; shuffleArray(options); let optionsHTML = options.map(opt => `<button onclick="selectAnswer(this, '${opt}')" class="btn option-btn w-full text-left p-4 text-lg mb-3">${opt}</button>`).join(''); contentHTML = `<h2 class="text-2xl font-bold text-slate-700 mb-4">${stage.question}</h2><div id="quiz-options">${optionsHTML}</div><div id="feedback" class="mt-4 min-h-[2.5rem]"></div><button id="check-btn" onclick="checkAnswer()" class="btn btn-primary w-1/2 mt-4 opacity-50" disabled>Check</button>`; } contentEl.innerHTML = contentHTML; }

    function buyItem(itemId) { const item = gameData.shopItems.find(i => i.id === itemId); if (playerData.magatamaGems >= item.cost) { playerData.magatamaGems -= item.cost; playerData.purchasedItemIds.push(item.id); if (item.type === 'word') { addWordToCollection(item); } if (item.id === 'feature_japanese_menus') { playerData.japaneseMenusUnlocked = true; } document.getElementById('feedback').innerHTML = "Purchased!"; render(); } }

    function startLesson(lessonId) { gameState.activeLessonId = lessonId; gameState.currentLessonStage = 0; gameState.lessonMistakes = 0; changeScreen('lesson'); }

    function renderLessonStage() { const lesson = gameData.lessons.find(l => l.id === gameState.activeLessonId); const stage = lesson.stages[gameState.currentLessonStage]; titleEl.textContent = getUIText(lesson.title); renderLessonContent(stage); updateLessonProgress(gameState.currentLessonStage, lesson.stages.length); }

    function checkAnswer() { const lesson = gameData.lessons.find(l => l.id === gameState.activeLessonId); const stage = lesson.stages[gameState.currentLessonStage]; const isCorrect = gameState.selectedAnswer === stage.correctAnswer; if (!isCorrect) { gameState.lessonMistakes++; } if (isCorrect) { playerData.magatamaGems += 5; } lesson.stages.filter(s => s.type === 'learn').flatMap(s => s.vocab).forEach(addWordToCollection); handleAnswerResult(isCorrect, stage.correctAnswer, () => { setTimeout(nextLessonStage, 1500); }); }

    function nextLessonStage() { const lesson = gameData.lessons.find(l => l.id === gameState.activeLessonId); if (gameState.currentLessonStage < lesson.stages.length - 1) { gameState.currentLessonStage++; render(); } else { let bonus = 0; if (gameState.lessonMistakes === 0) { bonus = 10; playerData.magatamaGems += bonus; } gemsEl.textContent = playerData.magatamaGems; if (!playerData.completedLessonIds.includes(lesson.id)) { playerData.completedLessonIds.push(lesson.id); } if (lesson.id === 'introLesson' && playerData.completedLessonIds.length === 1) { titleEl.textContent = 'Welcome!'; return contentEl.innerHTML = `<h2 class="text-3xl font-bold text-red-500 mb-4">You've arrived!</h2>${bonus > 0 ? `<p class="text-emerald-500 font-bold">Perfect score! +10 bonus gems!</p>` : ""}<p class="text-slate-600 text-lg mb-6">You learned your first words. Enter the main shrine to continue your adventure.</p><button onclick="goToHub()" class="btn btn-primary">Enter Shrine</button>`; } titleEl.textContent = 'Lesson Complete!'; contentEl.innerHTML = `<h2 class="text-3xl font-bold text-red-500 mb-4">Well Done!</h2>${bonus > 0 ? `<p class="text-emerald-500 font-bold text-lg mb-4">Perfect score! +10 bonus gems!</p>` : ""}<p class="text-slate-600 text-lg mb-6">You've strengthened your knowledge.</p><button onclick="changeScreen('lessonSelect')" class="btn btn-primary">${getUIText("Back to Lessons")}</button>`; } }

    function handleAnswerResult(isCorrect, correctAnswer, callback, isRandomizer = false) { const feedbackEl = document.getElementById('feedback'); document.getElementById('check-btn').disabled = true; document.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; if (btn.textContent.trim() === correctAnswer) { btn.classList.add('correct'); } }); if (isCorrect) { feedbackEl.innerHTML = `<p class="text-green-600 font-bold text-lg">Correct! +${isRandomizer ? '10' : '5'} Gems!</p>`; } else { feedbackEl.innerHTML = '<p class="text-red-600 font-bold text-lg">Not quite. The correct answer is highlighted.</p>'; document.querySelector('.selected').classList.add('incorrect'); } gemDisplayEl.style.visibility = 'visible'; gemsEl.textContent = playerData.magatamaGems; if (callback) { callback(); } }

    function selectAnswer(button, answer) { document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); gameState.selectedAnswer = answer; const checkBtn = document.getElementById('check-btn'); checkBtn.disabled = false; checkBtn.classList.remove('opacity-50'); }

    function renderSentenceQuest() { titleEl.textContent = getUIText('Sentence Quest'); let contentHTML; if (!playerData.sentenceQuestUnlocked) { const canAfford = playerData.magatamaGems >= gameData.sentenceQuest.unlockCost; contentHTML = `<p class="text-slate-600 text-lg mb-4">Unlock this mode to build sentences from the words you've collected.</p><p class="text-slate-500 mb-6">Cost: ${gameData.sentenceQuest.unlockCost} Magatama Gems.</p><button ${canAfford ? "" : 'disabled'} onclick="unlockSentenceQuest()" class="btn btn-warning">${getUIText('Unlock')}</button>`; } else if (gameState.activeSentence) { const sentenceLength = gameState.activeSentence.japanese.length; let choices = [...gameState.activeSentence.japanese]; const otherWords = playerData.collectedWords.filter(w => !choices.includes(w.character)).map(w => w.character); shuffleArray(otherWords); for (let i = 0; i < 2 && i < otherWords.length; i++) { choices.push(otherWords[i]); } shuffleArray(choices); const playerSentenceHTML = gameState.playerSentence.map((word) => `<button class="btn btn-primary text-2xl p-4">${word}</button>`).join(''); const choicesHTML = choices.map(word => `<button class="btn btn-secondary text-2xl p-4" onclick="selectSentenceWord('${word}', this)">${word}</button>`).join(' '); contentHTML = `<div class="space-y-4"><p class="text-slate-600 text-lg">Translate this sentence:</p><h2 class="text-3xl font-bold text-slate-800">"${gameState.activeSentence.english}"</h2><div id="sentence-answer-area" class="card bg-slate-100 min-h-[6rem] flex items-center justify-center flex-wrap gap-2 p-2">${playerSentenceHTML || '<span class="text-slate-400">Select words below</span>'}</div><div id="sentence-choices" class="flex flex-wrap gap-2 justify-center">${choicesHTML}</div><div id="feedback" class="min-h-[1.5rem] font-bold"></div><div class="flex gap-4 justify-center"><button class="btn btn-secondary" onclick="resetSentence()">Reset</button><button id="check-sentence-btn" class="btn btn-primary" ${gameState.playerSentence.length !== sentenceLength ? "disabled" : ""} onclick="checkSentence()">Check</button></div></div>`; } else { const available = getAvailableSentences(); contentHTML = `<p class="text-slate-600 text-lg mb-6">You have unlocked ${available.length} sentence(s). Collect more words to find new ones!</p><button class="btn btn-primary" ${available.length > 0 ? "" : 'disabled'} onclick="startNewSentenceQuest()">Start Quest</button>${available.length > 0 ? '' : '<p class="text-red-500 mt-2">Collect more words to start!</p>'}`; } contentEl.innerHTML = `${contentHTML}<button onclick="goToHub()" class="btn btn-secondary mt-6">${getUIText('Back to Shrine')}</button>`; }

    function unlockSentenceQuest() { if (playerData.magatamaGems >= gameData.sentenceQuest.unlockCost) { playerData.magatamaGems -= gameData.sentenceQuest.unlockCost; playerData.sentenceQuestUnlocked = true; render(); } }

    function startNewSentenceQuest() { const available = getAvailableSentences(); if (available.length === 0) return; const unseen = available.filter(s => !playerData.seenSentenceIds.includes(s.id)); let nextSentence = unseen.length > 0 ? unseen[0] : available[Math.floor(Math.random() * available.length)]; gameState.activeSentence = nextSentence; gameState.playerSentence = []; render(); }

    function selectSentenceWord(word, buttonEl) { gameState.playerSentence.push(word); buttonEl.disabled = true; renderSentenceQuest(); }

    function resetSentence() { gameState.playerSentence = []; renderSentenceQuest(); }

    function checkSentence() { const playerString = gameState.playerSentence.join(''), correctString = gameState.activeSentence.japanese.join(''); let feedbackHTML; if (playerString === correctString) { playerData.magatamaGems += 15; gemsEl.textContent = playerData.magatamaGems; feedbackHTML = '<p class="text-green-500">Correct! +15 Gems!</p>'; if (!playerData.seenSentenceIds.includes(gameState.activeSentence.id)) { playerData.seenSentenceIds.push(gameState.activeSentence.id); } setTimeout(() => { gameState.activeSentence = null; render(); }, 2000); } else { feedbackHTML = '<p class="text-red-500">Not quite, try again!</p>'; } document.getElementById('feedback').innerHTML = feedbackHTML; }

    function startRandomizer() { if (playerData.collectedWords.length < 5) return; gameState.randomizerQuestions = []; let wordsPool = [...playerData.collectedWords]; shuffleArray(wordsPool); let selectedWords = wordsPool.slice(0, 5); for (const correctWord of selectedWords) { let question, correctAnswer; let options = []; let wrongWords = playerData.collectedWords.filter(w => w.character !== correctWord.character); shuffleArray(wrongWords); let wrongOptions = wrongWords.slice(0, 3); const questionType = Math.floor(Math.random() * 3); if (questionType === 0) { question = `What is the meaning of "${correctWord.character}"?`; correctAnswer = correctWord.meaning; options = wrongOptions.map(w => w.meaning); } else if (questionType === 1) { question = `Which character means "${correctWord.meaning}"?`; correctAnswer = correctWord.character; options = wrongOptions.map(w => w.character); } else { question = `What does the romaji "${correctWord.romaji}" mean?`; correctAnswer = correctWord.meaning; options = wrongOptions.map(w => w.meaning); } options.push(correctAnswer); shuffleArray(options); gameState.randomizerQuestions.push({ question, options, correctAnswer }); } gameState.currentRandomizerQuestion = 0; gameState.randomizerScore = 0; changeScreen('randomizerQuiz'); }
    
    function renderRandomizerQuiz() { titleEl.textContent = `${getUIText('Challenge Arena')} (${gameState.currentRandomizerQuestion + 1} / 5)`; if (gameState.currentRandomizerQuestion >= gameState.randomizerQuestions.length) { const reward = gameState.randomizerScore * 10; playerData.magatamaGems += reward; gemsEl.textContent = playerData.magatamaGems; titleEl.textContent = "Challenge Complete!"; contentEl.innerHTML = `<h2 class="text-3xl font-bold text-red-500 mb-4">Quiz Finished!</h2><p class="text-slate-600 text-lg mb-4">You scored ${gameState.randomizerScore} out of 5!</p><p class="text-emerald-500 font-bold text-lg mb-6">You earned ${reward} gems!</p><button onclick="goToHub()" class="btn btn-primary">Back to Shrine</button>`; return; } const stage = gameState.randomizerQuestions[gameState.currentRandomizerQuestion]; gameState.selectedAnswer = null; let optionsHTML = stage.options.map(opt => `<button onclick="selectAnswer(this, '${opt}')" class="btn option-btn w-full text-left p-4 text-lg mb-3">${opt}</button>`).join(''); let contentHTML = `<h2 class="text-2xl font-bold text-slate-700 mb-4">${stage.question}</h2><div id="quiz-options">${optionsHTML}</div><div id="feedback" class="mt-4 min-h-[2.5rem]"></div><button id="check-btn" onclick="checkRandomizerAnswer()" class="btn btn-primary w-1/2 mt-4 opacity-50" disabled>Check</button>`; contentEl.innerHTML = contentHTML; }
    
    function checkRandomizerAnswer() { const stage = gameState.randomizerQuestions[gameState.currentRandomizerQuestion]; const isCorrect = gameState.selectedAnswer === stage.correctAnswer; if (isCorrect) { gameState.randomizerScore++; playerData.magatamaGems += 10; } handleAnswerResult(isCorrect, stage.correctAnswer, () => { gameState.currentRandomizerQuestion++; setTimeout(renderRandomizerQuiz, 1500); }, true); }
    
    function updateLessonProgress(current, total) { progressBarContainer.style.display = 'block'; progressBar.style.width = `${(current / (total - 1)) * 100}%`; }

    // --- NAVIGATION & UTILITY ---
    function goToHub() { changeScreen('hub'); }
    function changeScreen(screen) { gameState.currentScreen = screen; render(); }
    function unlockLesson(lessonId) { const lesson = gameData.lessons.find(l => l.id === lessonId); if (playerData.magatamaGems >= lesson.cost) { playerData.magatamaGems -= lesson.cost; playerData.unlockedLessonIds.push(lesson.id); document.getElementById('feedback').innerHTML = '<p class="text-green-600 font-bold">Lesson unlocked!</p>'; setTimeout(render, 1000); } }
    function unlockRandomizer() { if (playerData.magatamaGems >= gameData.randomizer.unlockCost) { playerData.magatamaGems -= gameData.randomizer.unlockCost; playerData.randomizerUnlocked = true; render(); } }
    function addWordToCollection(word) { if (!playerData.collectedWords.some(w => w.character === word.character)) { playerData.collectedWords.push({ character: word.character, romaji: word.romaji, meaning: word.meaning }); } }
    
    function saveGame() { try { const dataStr = JSON.stringify(playerData); const dataBlob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = 'fox-shrine-save.json'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); } catch (error) { console.error("Save failed:", error); alert("Sorry, the game could not be saved. Please try again."); } }
    
    function handleFileLoad(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const loadedData = JSON.parse(e.target.result); if (loadedData && typeof loadedData.magatamaGems !== 'undefined' && Array.isArray(loadedData.collectedWords)) { if (!loadedData.seenSentenceIds) loadedData.seenSentenceIds = []; playerData = loadedData; goToHub(); } else { alert("Invalid save file."); } } catch (error) { console.error("Failed to load or parse save file:", error); alert("Could not load the save file. It may be corrupted."); } }; reader.readAsText(file); }

    // Initial render
    render();
</script>
</body>
</html>

